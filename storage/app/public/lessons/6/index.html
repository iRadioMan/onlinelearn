<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тема 6</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="text">
        <p>Реализуем функции добавления, редактирования и удаления данных.</p>

		<h1>Реализация функции добавления</h1>

		<p>1. На странице AddEditPage добавим новое поле, которое будет хранить в себе экземпляр добавляемого автомобиля</p>

		<p><img alt="" src="img/1.jpg" /></p>

		<p>2. При инициализации установим DataContext страницы &mdash; этот созданный объект</p>

		<p><img alt="" src="img/2.jpg" /></p>

		<p>3. Затем, используя привязку данных, укажем, какому свойству обращаться к каждому элементу при загрузке данных. Например, свойство Text у первого TextBox&#39;а будет обращаться к модели автомобиля</p>

		<p><img alt="" src="img/3.jpg" /></p>

		<p>4. Второй элемент будет обращаться к номеру автомобиля, третий к цвету, а четвертый - к стоимости аренды</p>

		<p><img alt="" src="img/4.jpg" /></p>

		<p>5. Далее обработаем нажатие на кнопку Сохранение и в коде пропишем логику обращения к модели данных и добавления нового экземпляра автомобиля</p>

		<p>a) Прежде чем сохранять данные, сделаем проверки на правильную&nbsp;заполняемость объектов</p>

		<p><img alt="" src="img/5.jpg" /></p>

		<p>b) После прохождения проверки нужно узнать, возникли ли ошибки, обратившись к переменной errors. Если в переменной что-то есть, то необходимо вывести сообщение об ошибке (то, что накопилось во время проверки). Соответственно, дальнейшее выполнение функции не нужно, и с помощью оператора return &mdash; мы выходим</p>

		<p><img alt="" src="img/6.jpg" /></p>

		<p>c) Если же все хорошо, и у нас происходит операция добавления (т.е. еще не присвоен код нового автомобиля), то мы будем пытаться добавить модель или экземпляр созданного автомобиля. Получив его контекст и обратившись к таблице автомобилей, с помощью метода Add мы добавляем созданный экземпляр</p>

		<p><img alt="" src="img/7.jpg" /></p>

		<p>d) Далее напишем код для сохранения изменений, используя метод SaveChanges. Этот метод является коварным, его необходимо поместить в блок try-catch, чтобы он отработал корректно, и в случае возникновения какой-либо непредвиденной ошибки, приложение не &laquo;упало&raquo;, а корректно работало. Мы выведем сообщение об ошибке, если она появилась. В случае успешного сохранения выведем сообщение о том, что информация сохранена.</p>

		<p><img alt="" src="img/8.jpg" /></p>

		<p>6. Теперь можно вернуться назад. При возврате на страницу со списком автомобилей, нам необходимо выводить актуальную информацию, обновляя список в таблице. Для этого мы будем использовать событие у страницы IsVisibleChange. Оно срабатывает каждый раз, когда страница отображается, либо скрывается</p>

		<p><img alt="" src="img/9.jpg" /></p>

		<p>С помощью F12 переходим в код. Если видимость страницы isVisible, мы будем обращаться к контексту с помощью свойства ChangeTracker ко всем сущностям, которые есть. И для каждой из них будем выполнять метод перезагрузки и вывода актуальных данных. После этого таблицу DGridCars присвоим таблице &laquo;список автомобилей&raquo;</p>

		<p><img alt="" src="img/10.jpg" /></p>
		
		<p>7. Запускаем программу и проверяем функцию добавления данных</p>

		<h1>Реализация функции редактирования</h1>

		<p>Для функции редактирования данных целесообразно использовать ту же страницу, что мы делали для добавления. Каким образом это будет происходить? В случае, если пользователь намерен изменить информацию об объекте, система будет отображать страницу добавления с информацией о редактируемом объекте. Измененная информация будет фиксироваться в базе данных и отображаться в списке, как было при добавлении.</p>

		<p>В первую очередь добавим параметр нашей странице AddEditPage. В нее мы будем передавать экземпляр выбранного автомобиля и, в случае если он не пустой, присваивать нашему полю CurrentCar. Мы не можем сейчас запустить приложение, т. к. возник ряд ошибок</p>

		<p><img alt="" src="img/11.jpg" /></p>

		<p>Вызов страницы AddEditPage теперь требует какого-то аргумента. В случае, если мы будем делать добавление, мы просто пропишем null (отправим пустой экземпляр). При этом для редактирования BtnEdit мы уже будем передавать экземпляр, прописав для этого код. Вместо null будем обращаться к кнопке, на которую нажали, получать ее контекст и знать, что это &mdash; автомобиль</p>

		<p><img alt="" src="img/12.jpg" /></p>

		<p>Попробуем теперь посмотреть, что получилось</p>

		<p><img alt="" src="img/13.jpg" /></p>

		<p>Те данные, которые мы хотим отредактировать, автоматически привязались к этим элементам управления и отображаются корректно. В случае, если мы отредактируем какое-то поле &mdash; нажимаем на кнопку Сохранить. Информация будет обновлена</p>

		<p><img alt="" src="img/14.jpg" /></p>

		<h1>Реализация функции удаления</h1>

		<p>Для реализации функции удаления отдельное окно не потребуется. Это значительно сократит время на разработку, но удаление требует к себе особого внимания. Любые действия, безвозвратно изменяющие данные в базе данных, должны запрашивать подтверждение пользователя. Именно поэтому, в первую очередь, для нажатия на кнопку удаления мы реализуем сообщение с вопросом: действительно ли пользователь хочет это сделать.</p>

		<p>Итак, получаем список автомобилей для удаления, обратившись к таблице с автомобилями. Выбираем все элементы, которые мы выделили, преобразуем их в список автомобилей. И затем, в сообщении, будем спрашивать пользователя: &laquo;Вы точно хотите удалить следующие carsForRemoving.Count() элементов?&raquo;. Укажем здесь заголовок сообщения &mdash; &laquo;Внимание&raquo;, затем укажем, какие кнопки доступны при диалоге с пользователем: &laquo;Да&raquo; или &laquo;Нет&raquo;, и выберем изображение &mdash; &laquo;Question&raquo;</p>

		<p><img alt="" src="img/15.jpg" /></p>

		<p>Если результатом диалога от пользователя было нажатие на кнопку &laquo;yes&raquo;, то мы будем выполнять удаление. Для этого обратимся к модели данных, используя блок TryCatch. Получив контекст, попробуем с помощью метода RemoveRange удалить все полученные выделенные автомобили. В случае, если все будет хорошо, отобразим сообщение. Иначе, выводим сообщение об ошибке. Также, в случае, если удаление произойдет успешно, отдельно вызовем обновление актуальных данных</p>

		<p><img alt="" src="img/16.jpg" /></p>

		<p>Сохраним и проверим работу приложения. Выделим два автомобиля</p>

		<p><img alt="" src="img/17.jpg" /></p>

		<p>Нажмем удалить &mdash; точно хотим удалить следующие 2 элемента</p>

		<p><img alt="" src="img/18.jpg" /></p>

		<p><img alt="" src="img/19.jpg" /></p>

		<p>Информация обновилась &mdash; данные были удалены</p>

		<p><img alt="" src="img/20.jpg" /></p>

		<h1>Итоги</h1>

		<p>Мы оформили вывод данных, реализовали функции добавления, редактирования и удаления данных. Это основной функционал при работе с данными, который пригодится вам при разработке любого программного решения.</p>

    </div>
</body>
</html>